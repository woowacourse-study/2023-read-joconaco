# 6.3 예상치 못한 부수 효과를 피하라

**부수 효과**(side effect)는 **어떤 함수의 호출이 함수 외부에 초래한 상태 변화**를 의미한다.
> 도기: **부수 효과**는 **어떤 함수의 호출이 외부에 상태 변화를 일으키는 것**을 의미한다고 생각해요.

함수가 반환하는 값 외에 **다른 효과**가 있다면 이는 부수 효과가 있는 것이다.

일반적인 부수 효과 유형
- 사용자에게 출력 표시
- 파일이나 DB에 무언가를 저장
- 다른 시스템을 호출하여 네트워크 트래픽 발생
- 캐시 업데이트 혹은 무효화

그렇다고 함수가 호출되어 위의 행위들을 한다고 모두 부수 효과는 아니다.<br>
부수 효과는 소프트웨어 작성 시 불가피하다. 하지만, 위의 행위를 기대하지 않았음에도 일어난다면, 그때 **부수 효과**가 일어났다고 할 수 있다.

부수 효과는 버그를 유발할 수 있기에 항상 경계해야 한다.

그렇다면 부수 효과를 어떻게 피할 수 있을까?<br> 
클래스를 **불변**으로 만드는 것이 부수 효과의 가능성을 최소화하는 좋은 방법이다.<br>
또한, 부수 효과가 원하는 기능의 일부거나 피할 수 없는 경우에는 함수를 호출하는 쪽에서 이에 대해 확실하게 인지시키는 것이 중요하다.

# 6.3.1 분명하고 의도적인 부수 효과는 괜찮다.
```java
class UserDisplay {
    private final Canvas canvas;
    
    public void displayErrorMessage(String message) {
        canvas.drawText(message, Color.RED);
    }
}
```
위의 코드는 **사용자에게 출력을 표시**하는 부수 효과를 가지고 있다.<br>
하지만, 전혀 문제가 되보이지 않는다.<br>
이유는 클래스명과 함수명이 부수 효과를 일으킨다고 명시하기 때문이다.<br>
이를 호출하는 클라이언트는 예상치 못한 부수 효과가 발생했다고 문제를 제기하지 않을 것이다.

# 6.3.2 예기치 않은 부수 효과는 문제가 될 수 있다.
반대로 예상하지 못한 부수 효과는 **문제가 될 수 있다.**

```java
class UserDisplay {
    private final Canvas canvas;
    
    Color getPixel(int x, int y) {
        canvas.redraw();
        
        Pixel pixel = canvas.getPixel(x, y);
        return new Color(
                pixel.getRed(),
                pixel.getGreen(),
                pixel.getBlue()
        );
    }
}
```
위 코드는 canvas에서 x, y 좌표의 픽셀값을 가져오는 코드이다.<br>
하지만, 픽셀값을 가져오는 과정에서 예상하지 못한 부수 효과가 발생한다.<br>
바로 `canvas.redraw()` 가 문제가 된다.<br>

이 함수를 호출하는 사람은 canvas를 다시 그릴 것이라고는 전혀 상상하지 못할 것이다.<br>
그렇기 때문에 위 코드 한 줄 때문에 문제가 발생해도 어디서 문제가 발생했는 지 쉽게 찾아내지 못할 것이다.

그렇다면 어떤 점이 문제가 되는지 좀 더 자세히 살펴보자.

## 비용이 많이 들 수 있다
위에서 봤던 부수 효과의 일반적인 예를 다시 보자.

- 사용자에게 출력 표시
- 파일이나 DB에 무언가를 저장
- 다른 시스템을 호출하여 네트워크 트래픽 발생
- 캐시 업데이트 혹은 무효화

모두 적은 비용이 드는 동작은 아니다.<br>
위 행위를 예상하지 않는 상황에서 호출이 된다면, 프로그램 성능에 영향을 줄 수 있는 문제가 된다.<br>

만약 위의 예에서 사용자가 화면을 캡처하는 상황을 가정해보자.

```java
class UserDisplay {
    private final Canvas canvas;
    
    public Color getPixel(int x, int y) { ... }
    
    public Image capture() {
        Image image = new Image(canvas.getWidth(), canvas.getHeight());
        
        for (int x = 0; x < image.getWidth(); x++) {
            for (int y = 0; y < image.getHeight(); y++) {
                Pixel pixel = image.getPixel(x, y); // 성능 이슈 발생 !!
                image.setPixel(pixel);
            }
        }
        
        return image;
    }
}
```

`getPixel()`을 호출할 때마다 `canvas.redraw()`가 호출되기 때문에 성능에 엄청난 이슈를 줄 것이다 !

## 호출하는 쪽이 예상치 못한 동작을 한다

이번에는 화면의 일부를 지운 화면을 캡처하는 기능을 다른 개발자가 구현한다고 가정해보자

```java
class UserDisplay {
    private final Canvas canvas;
    
    Image captureRedact() {
        redact(); // 화면의 일부를 지운다.
        Image screenshot = capture(); // 부수 효과 발생
        canvas.redraw(); // 이 함수를 구현하는 사람의 의도적인 코드
        
        return screenshot;
    }
}
```

이 함수의 개발자는, 화면의 일부를 지우고 `caputre()`해서 이미지로 저장 후, 화면을 다시 그려주고나서 저장한 이미지를 반환하길 원한다.<br>
하지만, `capture()` 메서드에서 이미 `canvas.redraw()`를 화면의 가로, 세로의 곱만큼 실행한다.

## 다중 스레드 코드의 버그
만약, 위의 응용 프로그램을 이용하는 사용자가 **자신의 화면을 친구와 라이브로 공유**할 수 있다는 기능이 있다고 가정해보자.<br>
이 기능은 주기적으로 화면을 캡처하여 다른 스레드가 캡처한 화면을 친구에게 전송하여 구현할 수 있다.

이때 **예상하지 못한 부수 효과** (`canvas.redraw()`) 때문에 문제가 발생할 수 있다.

- 스레드1 - `getPixel(x, y)` -> `canvas.redraw()` -> 스레드2
- 스레드2 - `getPixel(x, y)` -> `canvas.redraw()` -> 다시 그리기 시작 -> 스레드1
- 스레드1 - `Pixel pixel = canvas.getPixel(x, y)` -> 스레드2
- 스레드2 - 다시 그리기 완료

위 과정에서 스레드1의 `Pixel pixel = canvas.getPixel(x, y)`는, 스레드2가 캔버스를 다시 그리고 있는 와중에 실행된다.<br>
때문에 원하는 시점의 `getPixel()`이 이루어지지 않게 된다.

이는 모두 `getPixel()`에 존재하는 `canvas.redraw()` 때문에 발생하는 **부수 효과**이다.

## 결론
예상치 못한 **부수 효과**는 **비용이 많이 들거나**, **호출하는 쪽에 예상치 못한 동작을 야기**하거나, **멀티 스레드 코드의 버그**를 일으킬 수 있다.

즉, 예상치 못한 부수 효과를 항상 경계하자 !!

# 6.3.3 해결책: 부수 효과를 피하거나 그 사실을 분명하게 하라

좋은 코드의 특징 중 하나는, **예측 가능한 코드**이다.<br>
하지만, 예상치 못한 부수 효과는 위와 완전히 반대되는 것이다.

예측 가능한 코드를 짜기 위해선, **애초에 부수 효과를 일으키지 않는 것**이다.<br>
그런데, 아까 부수 효과는 소프트웨어를 작성하며 반드시 일어나는 행위라고 했다. 그렇다면 소프트웨어를 작성하지 않으면 되는 것인가??

그러기보다는 부수 효과가 일어난다면, **일어난다는 사실을 분명하게 알려야 한다.**

`getDraw()` 내에 `redraw()`가 정말 적재적소에 필요한 코드인지 확인해볼 필요가 있고, 만약 정말 필요한 코드라면 `getDraw()` 대신, `redrawAndGetPixel()`로 변수명을 설정하여 함수가 하는 행위를 외부에 **분명하게 알릴 필요가 있다.**
