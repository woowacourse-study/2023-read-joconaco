# 10.4.1 테스트 더블을 사용하는 이유

테스트 더블을 사용해야 하는 이유는 다음과 같다.

- 테스트 단순화
    - 일부 의존성은 테스트에 사용하기 어렵다. 의존성은 많은 설정이 필요할 수 있는데, 이러면 테스트는 복잡해지고 구현 세부 사항과 밀접하게 결합된다. 의존성 사용 대신 테스트 더블을 사용하면 작업이 단순해진다.
- 테스트로부터 외부 세계 보호
    - 일부 의존성은 부수효과를 발생시킨다. ex) 실제 서버에 요청을 전송, 실제 db에 값을 작성 등등 을 하면 중요한 프로세스에 나쁜 결과를 초래할 수 있다.
      이 상황에서 테스트 더블을 사용하면 외부 세계 시스템을 테스트의 동작으로부터 보호할 수 있다.
- 외부로부터 테스트 보호
    - 외부 세계는 비결정적 일 수 있다. ex ) 다른 프로그램이 db에 쓴 값(변할수있음) 을 테스트가 읽는다면 테스트 결과를 신뢰할 수 없다. 테스트 더블은 항상 동일하게 결정적 방식으로 작동한다.
    - ocean이라는 이름의 키(180)을 가져온다고 테스트를 작성했는데 다른 프로그램에서 ocean의 키를 190으로  수정한다면 이 테스트는 비결정적이므로 신뢰할 수 없다.

## 테스트 단순화

어떤 의존성은 설정하는데 많은 노력이 필요할 수 있다. 많은 매개변수, 많은 하위 의존성을 설정해야할 수 있기 때문이다. 이런 상황에서는 테스트 코드 설정을 위한 코드가 많이 쌓이게 되며, 구현 세부정보와 밀접하게 연결될 수 있다.
![사진1](https://user-images.githubusercontent.com/86547109/227728942-9b5548dc-df2c-44f2-9e8a-d67b06359f6f.png)

테스트에서 의존성을 실제로 사용하는 것은 비현실적이다. 의존성을 사용 시 설정이 필요하거나 하위 의존성에서 무언가 검증이 필요하다면 테스트 더블을 쓰는게 낫다!

테스트 더블을 사용한다면 실제 의존성을 설정하거나 하위 의존성에서 무언가 검증을 할 필요가 없다.

![사진2](https://user-images.githubusercontent.com/86547109/227728982-6578de98-d945-4175-a436-c4fb86d65fc4.png)

테스트 단순화를 사용하는 이유중에 다른 하나는 테스트를 더 빠르게 실행할 수 있는 것이다.

의존성을 가진 코드에서 계산 비용이 많이 드는 알고리즘을 호출하거나, 시간이 오래걸린다면 이에 해당한다.

이후 절에서는 테스트 더블을 설정하는 것이 의존성을 설정하는 것보다 복잡할 가능성이 있음을 보여준다. 그래서 테스트 단순화를 위한 테스트 더블의 사용 여부는 사례별로 고려해야한다.

## 테스트로부터 외부 세계 보호

어쩔 수 없이 격리된 상태로 테스트를 해야하는 경우도 있다.

결제를 처리하는 시스템을 사용하고, 고객 은행 계좌에서 돈을 인출하는 코드를 테스트한다고 해보자.

코드가 실제로 실행되면 이에 대한 부수효과로 고객의 실제 계좌에서 돈이 인출될 것이다.

예시로 코드는 `BankAccount`라는 클래스를 이용해서 작업을 수행한다. 테스트에 `BankAccount`클래스 인스턴스를 사용하면 테스트 실행시 마다 실제 계좌에서 돈이 인출될 것이다. 이렇게 수행되면 안된다.

![사진3](https://user-images.githubusercontent.com/86547109/227729009-913121f0-a6a1-4874-a1e0-3b3dcb885126.png)

이것이 우리가 테스트로부터 외부 세계를 보호해야하는 예다. 실제 BankAccount 인스턴스 대신 테스트 더블을 사용하면 테스트로부터 외부 세계를 보호할 수 있다. 그러면 테스트 실행시 실제 값에 영향을 안준다.

🌊: 현재 저도 체스 db 테스트코드를 작성하면 실제 db에 들어가는 문제가 있습니다 .. 😂 이런거 해결하려고 사용하나 봐요

![사진4](https://user-images.githubusercontent.com/86547109/227729040-1286694c-ba87-4da8-a2a5-adee1f8785b6.png)
실제 서버로 요청을 보내거나, 실제 데이터베이스에 값을 쓰는 부수 효과를 유발하는 테스트는 일어날 가능성이 많다! (우리의 체스 테스트처럼!) 이 문제는 치명적이진 않지만 문제가 발생할 수 있다.

- 사용자는 이상하고 혼란스러운 값을 본다.
    - 테스트한 레코드가 사용자에게 표시될 수 있다. 가짜 테스트 아이템은 사용자에게 방해할 수 있다.
- 모니터링 및 로깅에 영향을 끼친다.
    - 테스트 결과 오류 응답이 올바르게 오는지 테스트를 위해 일부러 잘못된 요청을 할 수 있다. 하지만 이게 실제 서버로 전송되면 오류율이 증가한다. 실제로 문제는 없지만 문제가 있다고 생각할 수 있다.

고객 대면 시스템, 비즈니스에 중요한 시스템은 부수효과를 일으키지 않는 것이 중요하다. 이런 시스템은 테스트로부터 보호되어야 하며 테스트 더블은 테스트를 격리함으로써 이것을 효과적으로 수행한다 !

## 외부로부터 테스트 보호

외부 세계로 부터 테스트를 보호하기 위해서도 테스트 더블을 사용한다.

실제 의존성은 비결정적인 동작을 할 수 있다. 예를 들면 db에서 정기적으로 변경되는 값을 읽거나, 난수생성기를 사용하여 id생성하는 실제 의존성 같은 것들이 있을 수 있다.

이런 의존성을 테스트에 사용하면 테스트 결과를 신뢰하기 어려울 때가 있다.

테스트 더블이 외부로부터 테스트를 보호하는데 있어 어떻게 도움이 되는지 설명하기 위해 코드가 잔액을 읽는 동작을 살펴본다.

실제 은행 계좌는 돈을 입금,출금하기 때문에 자주 변한다. 테스트용 특별계좌를 만들어도 매달 이자, 수수료 때문에 잔액 변동이 있을 수 있어서 테스트 대상 코드가 실제 은행계좌를 사용한다면 테스트가 망가진다.
![사진4](https://user-images.githubusercontent.com/86547109/227729076-396b5346-506b-4581-9b5b-5fa87b6d1b87.png)
이에 대한 해결책으로 테스트를 실제 은행 시스템과 분리하는 것이다. 이를 테스트 더블을 통해 수행한다.

![사진5](https://user-images.githubusercontent.com/86547109/227729110-c880f7b2-bbc7-4c8b-8035-4b83357f8f43.png)

의존성을 사용하는 것이 바람직 하지 않거나 현실적으로 가능하지 않은 경우가 있다.

이럴 경우 테스트 더블을 사용하는 것이 낫다.

어떤 테스트 더블이 있는지는 이제 나온다 !
성하가 잘해주겠죠 ~